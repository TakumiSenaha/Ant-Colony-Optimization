# 遅延制約付き ACO 実験：手法説明と結果考察

## 1. 実験概要

本実験では、**遅延制約付きのボトルネック帯域幅最大化問題**に対して、提案手法（Proposed Method）の性能を評価します。遅延制約を導入することで、探索空間を制限し、パレート最適化の前段階として単一の最適解（または少数の最適解）に収束する確率を検証します。

### 1.1 問題設定

- **目的**: エンドツーエンド遅延が制約値以下である条件下で、ボトルネック帯域幅を最大化する経路を発見
- **制約条件**: 経路の累積遅延 $D \leq D_{\text{limit}}$（$D_{\text{limit}}$は設定可能な最大遅延）
- **評価指標**:
  - **Any Optimal**: 最大ボトルネック帯域幅を達成し、遅延制約を満たす経路のいずれかに到達した確率
  - **Unique Optimal**: 最大ボトルネック帯域幅を達成し、かつその中で最小遅延を持つ経路（辞書式順序最適解）に到達した確率

---

## 2. 手法の説明

### 2.1 提案手法（Proposed Method）の基本アルゴリズム

提案手法は、**自律学習機構（Autonomous Learning Mechanism）**を備えた完全分散型 ACO アルゴリズムです。

#### 2.1.1 経路選択戦略（ε-Greedy）

各アリは、現在のノード $i$ から次のノード $j$ を選択する際、以下の確率に従います：

- **確率 $1-\epsilon$**: フェロモン $\tau_{ij}$ とヒューリスティック情報（帯域幅 $w_{ij}$）に基づく確率的選択

  $$
  p_{ij}(t) = \frac{[\tau_{ij}(t)]^\alpha \cdot [w_{ij}]^\beta}{\sum_{l \in N_i(t)} [\tau_{il}(t)]^\alpha \cdot [w_{il}]^\beta}
  $$

  ここで、$N_i(t)$ はノード $i$ の未訪問隣接ノード集合、$\alpha=1.0$、$\beta=1.0$ です。

- **確率 $\epsilon$**: 完全ランダム選択（探索を促進）

#### 2.1.2 遅延制約の適用

**経路選択時の制約チェック**:

- アリが次のノード $j$ に移動する前に、現在の経路の累積遅延 + エッジ $(i,j)$ の遅延が $D_{\text{limit}}$ を超える場合は、そのエッジを候補から除外します。
- これにより、制約違反経路への探索を事前に防止します。

#### 2.1.3 ノード学習（Node Learning）

各ノード $v$ は、通過したアリから報告された解品質を学習します：

- **BKB（Best Known Bandwidth）**: ノード $v$ が通過した経路の最大ボトルネック帯域幅

  $$
  K_v \leftarrow \max(K_v, B)
  $$

  ただし、**遅延制約を満たす経路からの情報のみを学習**します（$D_{\text{path}} \leq D_{\text{limit}}$）。

- **学習のタイミング**: アリがゴールに到達し、帰還時に各ノードに報告します。

#### 2.1.4 フェロモン付加（Pheromone Deposition）

アリがゴールに到達した後、経路上の各エッジ $(i,j)$ にフェロモンを付加します：

$$
\Delta\tau_{ij} = \begin{cases}
0, & \text{if } D_{\text{path}} > D_{\text{limit}} \quad \text{(制約違反経路には付加しない)} \\
f(B) \cdot \left(\frac{D_{\text{limit}}}{D_{\text{path}}}\right) \cdot B_a, & \text{if } B \geq K_j \quad \text{(功績ボーナス)} \\
f(B) \cdot \left(\frac{D_{\text{limit}}}{D_{\text{path}}}\right), & \text{if } B < K_j \quad \text{(通常)}
\end{cases}
$$

ここで：

- $f(B) = 10 \cdot B$（基本フェロモン量）
- $B_a = 2.0$（功績ボーナス係数）
- $\frac{D_{\text{limit}}}{D_{\text{path}}}$ は遅延が小さいほど大きなフェロモンが付加されることを意味します（遅延優先項）

**重要な点**: 制約違反経路（$D_{\text{path}} > D_{\text{limit}}$）には**一切フェロモンを付加しません**。これにより、制約を満たさない経路への探索が抑制されます。

#### 2.1.5 フェロモン揮発（Pheromone Evaporation）

各世代終了時に、全エッジのフェロモンを揮発させます：

$$
\tau_{ij}(t+1) = r_{ij} \cdot \tau_{ij}(t)
$$

揮発率 $r_{ij}$ は、エッジの帯域幅 $w_{ij}$ とノード $j$ の BKB $K_j$ を比較して決定されます：

$$
r_{ij} = \begin{cases}
V \cdot P_f, & \text{if } w_{ij} < K_j \quad \text{(ペナルティ: より速く揮発)} \\
V, & \text{otherwise} \quad \text{(通常揮発)}
\end{cases}
$$

ここで：

- $V = 0.98$（基本残存率、揮発率 $1-V = 0.02$）
- $P_f = 0.5$（ペナルティ係数）

**双方向揮発**: エッジ $(i,j)$ と $(j,i)$ は**独立に揮発**し、それぞれの方向の出発ノードの BKB に基づいてペナルティが適用されます。

#### 2.1.6 フェロモン更新のタイミング（Online Update）

提案手法では、**完全分散方式**を採用しています：

- アリがゴールに到達した**即座に**フェロモンを更新します（バッチ更新ではなく、オンライン更新）
- これにより、良い経路の発見が即座に他のアリに伝播します

---

## 3. ネットワークの生成方法

### 3.1 グラフ構造

- **グラフタイプ**: Barabási-Albert（BA）モデル（スケールフリーネットワーク）
- **ノード数**: 100 ノード
- **エッジ数**: 各ノード追加時に $m=3$ 本のエッジを接続（BA モデルのパラメータ）

### 3.2 エッジ属性の設定

各エッジ $(u,v)$ には以下の属性が設定されます：

#### 3.2.1 帯域幅（Bandwidth）

- **範囲**: 10〜100 Mbps（10 刻み）
- **生成方法**: `random.randint(1, 10) * 10`
- **属性名**: `"bandwidth"`

#### 3.2.2 遅延（Delay）

- **範囲**: 1〜10 ms（1 刻み）
- **生成方法**: `random.randint(1, 10)`
- **属性名**: `"delay"`

**重要な点**: エッジの遅延は**静的**です（帯域変動が無効な場合）。各エッジの遅延は、経路の累積遅延計算に使用されます。

#### 3.2.3 フェロモン（Pheromone）

- **初期値**: `min_pheromone = 100`
- **最小値**: `min_pheromone = 100`
- **最大値**: `max_pheromone = 10^9`

### 3.3 ネットワーク生成の再試行

遅延制約が有効な場合、**最適解が存在しないネットワークは再生成**されます：

- スタートノードとゴールノードのペアがランダムに選択されます
- `max_load_path_with_delay_constraint` で制約を満たす経路が存在するか確認します
- 存在しない場合、ネットワークを再生成し、最大 100 回まで再試行します

---

## 4. 最適解の定義

### 4.1 最適解の計算方法

最適解は、**修正ダイクストラ法（Modified Dijkstra Algorithm）**を使用して計算されます。

#### 4.1.1 辞書式順序（Lexicographical Order）

最適解は以下の優先順位で決定されます：

1. **第一優先**: ボトルネック帯域幅 $B$ を最大化
2. **第二優先**: 同じボトルネック帯域幅を持つ経路の中で、累積遅延 $D$ を最小化

$$
\text{Optimal} = \arg\max_{(B,D)} \left\{ (B, -D) \mid D \leq D_{\text{limit}} \right\}
$$

#### 4.1.2 最適解の探索アルゴリズム

`max_load_path_with_delay_constraint` 関数は、以下の手順で最適解を探索します：

1. **優先度キュー**: $(-B, D)$ をキーとして使用（ボトルネック帯域幅を最大化、遅延を最小化）
2. **遅延制約チェック**: 各エッジ追加時に、累積遅延が $D_{\text{limit}}$ を超えないことを確認
3. **更新条件**:
   - より大きなボトルネック帯域幅が見つかった場合
   - または、同じボトルネック帯域幅でより小さい遅延が見つかった場合

### 4.2 Any Optimal と Unique Optimal の定義

#### 4.2.1 Any Optimal（任意の最適解）

**定義**: 最大ボトルネック帯域幅を達成し、遅延制約を満たす経路の**いずれか**に到達した場合に成功とみなします。

**計算方法**:

1. `find_all_max_bottleneck_paths_with_delay_constraint` で、最大ボトルネック帯域幅を持つ全ての経路を列挙
2. アリが発見した経路 $(B_{\text{ant}}, D_{\text{ant}})$ が、このリスト内のいずれかの経路と一致するか確認
3. 一致すれば成功（`ant_log_any_optimal` に `0` を記録）

**意味**: 制約を満たす範囲で最大帯域幅を達成できれば、どの経路でも良いという緩い評価基準です。

#### 4.2.2 Unique Optimal（一意の最適解）

**定義**: 最大ボトルネック帯域幅を達成し、かつその中で**最小遅延**を持つ経路（辞書式順序最適解）に到達した場合に成功とみなします。

**計算方法**:

1. まず、Any Optimal の条件を満たすか確認
2. 満たす場合、`current_optimal_solutions` から最小遅延 `min_delay_in_solutions` を計算
3. アリが発見した経路の遅延 `D_{\text{ant}}` が、`min_delay_in_solutions` と（浮動小数点誤差を考慮して）一致するか確認
4. 一致すれば成功（`ant_log_unique_optimal` に `0` を記録）

**意味**: 最大帯域幅を達成し、かつ最も低遅延な経路に到達する必要があるという厳しい評価基準です。

### 4.3 ログ記録の形式

- **成功（最適解発見）**: `0` を記録
- **失敗（ゴール未到達）**: `-1` を記録
- **失敗（制約違反）**: ゴールに到達したが遅延制約を満たさない場合は、フェロモン付加が行われないため、通常は `-1` として扱われます

---

## 5. 実験結果と考察

### 5.1 実験設定

- **制約条件**: $D_{\text{limit}} \in \{5.0, 10.0, 15.0\}$ ms
- **世代数**: 1000 世代
- **アリ数**: 1 世代あたり 10 匹
- **シミュレーション回数**: 100 回（独立実行）
- **評価指標**: 各世代で、10 匹のアリのうち少なくとも 1 匹が最適解を発見した場合、その世代を「成功」とみなす

### 5.2 実験結果

| 制約条件 | Any Optimal（最終世代） | Unique Optimal（最終世代） |
| -------- | ----------------------- | -------------------------- |
| 5.0 ms   | 100%                    | 100%                       |
| 10.0 ms  | 90%                     | 80%                        |
| 15.0 ms  | 70%                     | 60%                        |

### 5.3 考察

#### 5.3.1 制約が厳しい場合（5.0 ms）: 100%収束

**観察**: Any Optimal と Unique Optimal の両方が 100%に収束しました。

**考察**:

1. **探索空間の大幅な縮小**

   - エッジの遅延範囲が 1〜10 ms であるため、5.0 ms という厳しい制約は、**非常に短い経路（1〜2 ホップ）のみが有効**になります。
   - これにより、探索可能な経路の数が劇的に減少し、アリが最適解に集中しやすくなります。

2. **フェロモン付加経路の限定**

   - 制約違反経路（$D > 5.0$ ms）にはフェロモンが付加されないため、**有効な経路のみにフェロモンが蓄積**されます。
   - この「自然な選択圧」により、アリは必然的に制約を満たす経路に集中します。

3. **ノード学習の効果**

   - 短い経路では、ノードの BKB（Best Known Bandwidth）が迅速に更新され、**「このノードを通れば高帯域幅の経路に到達できる」という情報が即座に伝播**します。
   - これにより、探索の初期段階から最適解への収束が促進されます。

4. **Unique Optimal と Any Optimal の一致**
   - 探索空間が小さいため、最大ボトルネック帯域幅を達成する経路が**実質的に 1 つ（または非常に少数）**になります。
   - その結果、Any Optimal と Unique Optimal の成功率が一致します。

**結論**: 厳しい制約は、探索空間を制限することで、**探索効率を向上させ、高い収束率を実現**します。これは、制約が「探索のガイド」として機能していることを示しています。

#### 5.3.2 制約が中程度の場合（10.0 ms）: Any 90%, Unique 80%

**観察**: Any Optimal は 90%に収束しましたが、Unique Optimal は 80%に留まりました。

**考察**:

1. **探索空間の拡大**

   - 10.0 ms という制約は、5.0 ms よりも緩いため、**より多くの経路が有効**になります（3〜4 ホップ程度の経路も探索可能）。
   - これにより、探索空間が拡大し、最適解への収束がやや難しくなります。

2. **Any Optimal と Unique Optimal の差**

   - **Any Optimal**: 最大ボトルネック帯域幅を達成する経路のいずれかに到達すれば成功
   - **Unique Optimal**: 最大ボトルネック帯域幅を達成し、かつ最小遅延を持つ経路に到達する必要がある
   - 10.0 ms の制約下では、**同じ最大ボトルネック帯域幅を持つ複数の経路が存在**する可能性が高くなります。
   - その中で、最小遅延の経路を特定するには、より精密な探索が必要です。

3. **フェロモン分布の分散**

   - 有効な経路が増えると、フェロモンが複数の経路に分散します。
   - これにより、アリは最適解だけでなく、**準最適解（最大帯域幅だが遅延が最小ではない）にも誘導**される可能性があります。

4. **遅延優先項の効果**
   - フェロモン付加式の $\frac{D_{\text{limit}}}{D_{\text{path}}}$ 項により、低遅延経路により多くのフェロモンが付加されます。
   - しかし、探索空間が広いため、この効果が完全に発揮されるまでに時間がかかります。

**結論**: 中程度の制約では、探索空間が拡大することで、**Any Optimal は比較的高い成功率を維持**しますが、**Unique Optimal の達成にはより精密な探索が必要**になります。これは、制約が緩くなることで、最適解の「一意性」が失われることを示しています。

#### 5.3.3 制約が緩い場合（15.0 ms）: Any 70%, Unique 60%

**観察**: Any Optimal は 70%、Unique Optimal は 60%に留まりました。

**考察**:

1. **探索空間の大幅な拡大**

   - 15.0 ms という制約は、エッジの遅延範囲（1〜10 ms）を考慮すると、**ほぼ全ての経路が有効**になります（5〜6 ホップ程度の経路も探索可能）。
   - これにより、探索空間が最大となり、最適解への収束が最も難しくなります。

2. **フェロモン分布の広がり**

   - 有効な経路が非常に多いため、フェロモンが**多数の経路に分散**します。
   - これにより、アリは最適解だけでなく、**様々な準最適解にも誘導**され、収束が遅くなります。

3. **ノード学習の限界**

   - 探索空間が広いと、ノードの BKB が更新される頻度が低くなり、**「このノードを通れば高帯域幅の経路に到達できる」という情報の伝播が遅れます**。
   - また、複数の経路が存在するため、BKB が「最大帯域幅」を正確に反映するまでに時間がかかります。

4. **Any Optimal と Unique Optimal の差の拡大**

   - 探索空間が広いため、**同じ最大ボトルネック帯域幅を持つ経路が多数存在**します。
   - その中で、最小遅延の経路を特定するには、**より多くの探索が必要**になります。
   - その結果、Any Optimal と Unique Optimal の成功率の差が拡大します（70% vs 60%）。

5. **制約の「ガイド効果」の減少**
   - 制約が緩いと、制約が「探索のガイド」として機能しにくくなります。
   - アリは、制約を満たす経路の中から、**帯域幅と遅延の両方を考慮して選択**する必要がありますが、選択肢が多すぎるため、最適解への集中が難しくなります。

**結論**: 緩い制約では、探索空間が最大となり、**最適解への収束が最も難しくなります**。これは、制約が「探索のガイド」として機能するには、**適度な厳しさが必要**であることを示しています。一方で、制約が緩い場合でも、Any Optimal は 70%を達成しており、**提案手法は広い探索空間でも一定の性能を維持**していることがわかります。

### 5.4 総合考察

#### 5.4.1 制約の「二面性」

本実験の結果は、遅延制約が**「探索のガイド」として機能する**ことを示しています：

- **厳しい制約（5.0 ms）**: 探索空間を大幅に縮小し、フェロモンが有効な経路に集中することで、**高い収束率（100%）を実現**
- **緩い制約（15.0 ms）**: 探索空間が拡大し、フェロモンが分散することで、**収束率が低下（70%）**

これは、制約が「制限」として機能するだけでなく、**「探索の方向性を明確にする」という積極的な役割**を果たしていることを示しています。

#### 5.4.2 提案手法の適応性

提案手法は、制約の厳しさに応じて、**適応的に探索戦略を調整**します：

- **厳しい制約**: ノード学習とフェロモン付加の「自然な選択圧」により、有効な経路に迅速に集中
- **緩い制約**: 広い探索空間でも、ε-Greedy 戦略とノード学習により、一定の性能を維持

#### 5.4.3 Any Optimal と Unique Optimal の関係

- **Any Optimal**: 最大帯域幅を達成する経路のいずれかに到達すれば成功（緩い基準）
- **Unique Optimal**: 最大帯域幅を達成し、かつ最小遅延を持つ経路に到達する必要がある（厳しい基準）

制約が緩くなるほど、**同じ最大帯域幅を持つ経路が増える**ため、Unique Optimal の達成が難しくなります。これは、制約が緩い場合、**最適解の「一意性」が失われる**ことを示しています。

#### 5.4.4 実用的な示唆

1. **制約の設定**: 実用的なネットワーク設計では、**制約を適度に厳しく設定することで、探索効率を向上**させることができます。
2. **評価基準の選択**: アプリケーションの要件に応じて、Any Optimal と Unique Optimal のどちらを評価基準とするかを選択できます。
3. **探索のバランス**: 制約が緩い場合でも、提案手法は一定の性能を維持するため、**実用的なネットワーク環境でも適用可能**です。

---

## 6. まとめ

本実験では、遅延制約付きのボトルネック帯域幅最大化問題に対して、提案手法の性能を評価しました。結果は、**制約の厳しさが探索効率に大きな影響を与える**ことを示しており、適度に厳しい制約は「探索のガイド」として機能し、高い収束率を実現することがわかりました。一方で、制約が緩い場合でも、提案手法は一定の性能を維持し、実用的なネットワーク環境でも適用可能であることが確認されました。
