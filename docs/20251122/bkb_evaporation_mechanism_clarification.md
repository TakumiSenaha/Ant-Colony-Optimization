# BKB 揮発メカニズムの整理

## 現在の実装の意図

### 設計思想

**「アリが通った瞬間、新鮮な観測値で BKB を更新する」**

- 新しい観測値がある = 実際の帯域状況がわかる
- 揮発で減らした古い BKB 値よりも、新鮮な観測値の方が信頼できる
- したがって、新鮮な観測値で上書きするのは正しい動作

---

## 現在の実装の動作

### アリが通る場合

```
世代N: アリがノードXを通る
       → 新しい観測値（例: 80）を取得
       → window_values.append(80)  # リングバッファに追加
       → time_window_max = max(window_values)  # バッファ内のmax値
       → BKB = time_window_max  # 新鮮な観測値で更新（揮発の効果が消える）
```

**✅ これは正しい動作：新鮮な観測値があるなら、それを反映すべき**

---

### アリが通らない期間

```
世代N: 最後にアリがノードXを通った
       → BKB = 100（観測値から計算）
       → 揮発後: BKB = 99.9

世代N+1: アリがノードXを通らない
         → 新しい観測値なし
         → BKB = 99.9（前世代の揮発後の値）
         → フェロモン揮発時: BKB = 99.9 が参照される
         → 揮発後: BKB = 99.8

世代N+100: アリがノードXを通らない
           → 新しい観測値なし
           → BKB ≈ 90.5（揮発）
           → フェロモン揮発時: BKB ≈ 90.5 が参照される
```

**✅ アリが通らない期間、揮発により古い BKB 値が「陳腐化」する**
**✅ フェロモン揮発時に、陳腐化した BKB 値が参照される**

---

## 揮発が効果を発揮する場面

### 1. フェロモン揮発時のペナルティ判定

```python
# src/pheromone_update.py - apply_volatilization()

bkb_v = graph.nodes[v].get("best_known_bottleneck", 0)  # 揮発後のBKB値が参照される
if weight_uv < bkb_v:
    rate *= penalty_factor  # ペナルティ適用
```

**アリが通らない期間中:**

- BKB 値が揮発で下がる（例: 100 → 90.5）
- フェロモン揮発時に、この「陳腐化した BKB 値」が参照される
- ペナルティの閾値が下がる
- 新しい低帯域経路が選ばれやすくなる

**アリが通った瞬間:**

- 新鮮な観測値で BKB が更新される
- 最新の状況が反映される

---

### 2. 帯域変動後の適応

```
世代0: ノードXのBKB = 100（高い帯域を観測）
       → アリがノードXを通らない間、BKBが揮発

世代100: 帯域変動 → エッジ帯域幅 = 80
         → アリがまだノードXを通らない
         → BKB ≈ 90.5（揮発）
         → フェロモン揮発時: エッジ帯域幅80 < BKB 90.5
         → ペナルティが緩和される（揮発前の100よりも緩和）
         → アリが80の経路を選びやすくなる

世代101: アリがノードXを通る（80の経路）
         → 新しい観測値80でBKBが更新
         → BKB = max(window_values) = 80（新鮮な値で更新）
```

**✅ 揮発により、帯域変動後も新しい状況に適応しやすくなる**

---

## 結論

### 現在の実装の合理性

1. **アリが通らない期間**

   - BKB 値が揮発で「陳腐化」する
   - フェロモン揮発時に、陳腐化した BKB 値が参照される
   - これにより、古い高い BKB 値の影響が徐々に減る

2. **アリが通った瞬間**

   - 新鮮な観測値で BKB を更新する
   - 最新の状況を反映する

3. **揮発の効果**
   - 「アリが通らない期間中」に発揮される
   - フェロモン揮発時のペナルティ判定に影響する
   - 帯域変動後の適応を促進する

---

## 「なぜ 0.999 をかけただけで精度が変わるのか？」の答え

### 理由

1. **アリが通らない期間中、BKB 値は揮発し続ける**

   - 毎世代 0.999 をかける
   - 100 世代後: 100 × 0.999^100 ≈ 90.5

2. **フェロモン揮発時に、揮発後の BKB 値が参照される**

   - ペナルティの閾値が下がる
   - 新しい低帯域経路が選ばれやすくなる

3. **帯域変動後の適応が促進される**

   - 古い高い BKB 値の影響が減る
   - 新しい状況に適応しやすくなる

4. **アリが通った瞬間、新鮮な観測値で更新される**
   - 最新の状況が反映される
   - これにより、揮発で減らした古い値よりも新しい観測値が優先される

---

## まとめ

**現在の実装は意図通りに動作しています：**

- ✅ アリが通らない期間: BKB 値が揮発で「陳腐化」
- ✅ フェロモン揮発時: 陳腐化した BKB 値が参照され、ペナルティ判定に影響
- ✅ アリが通った瞬間: 新鮮な観測値で更新（揮発の効果が消えるが、これは正しい）

**「新鮮な値だと思うからいいですよね」→ その通りです！**



