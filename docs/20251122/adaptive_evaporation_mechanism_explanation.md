# 適応的揮発メカニズムの詳細説明

## 「すべて組み合わせて使用」とは？

揮発率の調整は、**5 つのルールを順番に乗算していく**方式です。

各ルールが独立に判定し、その結果を**掛け算**で組み合わせます。

---

## 具体例で理解する

### 例 1: 高変動環境で、次の低帯域時期が近い場合

```python
# 初期値
multiplier = 1.0  # 基本揮発率

# 1. 予測変動性ベース（条件付き、use_prediction_variability=Trueの場合）
#    5ステップ先の予測値の変動係数 = 0.35（高変動）
pred_cv = 0.35
if pred_cv > 0.3:  # 高変動予測
    multiplier *= 0.90  # 10%多く揮発
    # multiplier = 1.0 × 0.90 = 0.90

# 2. 変動係数（CV）ベース（常に適用）
#    過去の観測値の変動係数 = 0.32（高変動）
cv = 0.32
if cv > 0.3:  # 高変動環境
    multiplier *= 0.92  # 8%多く揮発
    # multiplier = 0.90 × 0.92 = 0.828

# 3. 周期性ベース（常に適用）
#    次の低帯域時期まで周期の15%（非常に近い）
period_ratio = 0.15
if period_ratio < 0.2:  # 周期の20%以内
    multiplier *= 0.88  # 12%多く揮発
    # multiplier = 0.828 × 0.88 = 0.7286

# 4. トレンドベース（常に適用）
#    減少傾向
trend = "decreasing"
if trend == "decreasing":
    multiplier *= 0.94  # 6%多く揮発
    # multiplier = 0.7286 × 0.94 = 0.6849

# 5. AR(1)係数ベース（常に適用）
#    AR(1)係数 = 0.4（中程度の自己相関）
ar_coeff = 0.4
# 0.3 < ar_coeff < 0.7 なので調整なし
# multiplier = 0.6849（変更なし）

# 最終チェック: 0.80 〜 1.10 の範囲に制限
multiplier = max(0.80, min(1.10, 0.6849))
# multiplier = 0.80（下限で制限）

# 結果: 基本揮発率に 0.80 を掛ける
# → 20%多く揮発する（探索を促進）
```

### 例 2: 安定環境で、改善傾向の場合

```python
# 初期値
multiplier = 1.0

# 1. 予測変動性ベース
pred_cv = 0.03  # 低変動（安定）
if pred_cv <= 0.05:  # 低変動予測
    multiplier *= 1.02  # 2%少なく揮発（活用促進）
    # multiplier = 1.0 × 1.02 = 1.02

# 2. CVベース
cv = 0.04  # 低変動（安定）
if cv <= 0.05:  # 低変動環境
    multiplier *= 1.01  # 1%少なく揮発
    # multiplier = 1.02 × 1.01 = 1.0302

# 3. 周期性ベース
#    次の低帯域時期まで周期の60%（遠い）
period_ratio = 0.6
# 0.5 < period_ratio なので調整なし
# multiplier = 1.0302（変更なし）

# 4. トレンドベース
trend = "increasing"  # 増加傾向（改善中）
if trend == "increasing":
    multiplier *= 1.02  # 2%少なく揮発（改善経路を保持）
    # multiplier = 1.0302 × 1.02 = 1.0508

# 5. AR(1)係数ベース
ar_coeff = 0.8  # 高い自己相関（予測可能）
if ar_coeff > 0.7:
    multiplier *= 1.01  # 1%少なく揮発
    # multiplier = 1.0508 × 1.01 = 1.0613

# 最終チェック
multiplier = max(0.80, min(1.10, 1.0613))
# multiplier = 1.0613（上限1.10以下なのでそのまま）

# 結果: 基本揮発率に 1.0613 を掛ける
# → 約6%少なく揮発する（活用を促進）
```

---

## 重要なポイント

### 1. **乗算の連鎖**

各ルールの結果が**順番に掛け算**されます：

```
最終的な乗算係数 = 基本値
                  × 予測変動性調整
                  × CV調整
                  × 周期性調整
                  × トレンド調整
                  × AR(1)係数調整
```

### 2. **各ルールは独立に判定**

- ルール 1 が適用されても、ルール 2 の判定には影響しない
- 各ルールは、それぞれ異なる観点（予測、過去の観測、周期、トレンド、自己相関）から判断する

### 3. **条件によっては適用されないルールもある**

- **予測変動性ベース**: `use_prediction_variability=False` の場合は適用されない
- **周期性ベース**: 周期が検出されていない場合は適用されない
- **トレンドベース**: トレンドが「安定」の場合は調整なし

### 4. **最終的な範囲制限**

全ての調整が終わった後、最終的な乗算係数は **0.80 〜 1.10** の範囲に制限されます。

- 極端な値（0.5 や 1.5 など）になることを防ぐ
- 揮発率が適切な範囲に収まることを保証

---

## なぜ「組み合わせて使用」するのか？

### 多角的な判断

各ルールは異なる観点から環境を評価します：

1. **予測変動性**: 将来の予測が不安定か？
2. **CV**: 過去の観測値がばらついているか？
3. **周期性**: 周期的に低帯域が来るのか？
4. **トレンド**: 帯域は改善しているか、悪化しているか？
5. **AR(1)係数**: 変動は予測可能か？

### 相乗効果

複数のルールが同じ方向（探索促進 or 活用促進）を示すと、相乗効果でより強い調整が行われます。

- **例**: 高変動 + 次の低帯域が近い + 減少傾向 → 強い探索促進（0.90 × 0.88 × 0.94 = 0.74）
- **例**: 安定 + 改善傾向 + 予測可能 → 強い活用促進（1.02 × 1.02 × 1.01 = 1.05）

---

## まとめ

**「すべて組み合わせて使用」** = 5 つのルールを順番に乗算して、最終的な揮発率の乗算係数を決定する

各ルールは独立に判定し、その結果を掛け算で組み合わせることで、多角的な判断に基づいた適応的揮発が実現されます。



