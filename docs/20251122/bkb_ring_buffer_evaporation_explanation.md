# リングバッファ BKB 学習における揮発処理の詳細説明

## 重要なポイント

**BKB の評価値として使うのは、リングバッファ内の最大値（max）です。**

## 処理のタイミングと順序

### 各世代の処理順序

1. **アリの探索**（経路を通る）
2. **BKB 更新**（アリがゴールに到達したとき）
   - `update_node_bkb_time_window_max`が呼ばれる
   - 観測値をリングバッファに追加
   - **バッファ内の max 値で BKB 値を更新**
3. **フェロモン揮発**
4. **BKB 揮発**（世代の最後）
   - `evaporate_bkb_values`が呼ばれる
   - **BKB 値（best_known_bottleneck）に 0.999 をかける**

---

## 具体例：リングバッファサイズ 10 の場合

### 前提条件

- リングバッファサイズ: 10
- BKB 揮発率: 0.999
- 最初の観測値: 100

### 世代ごとの詳細な動作

#### 世代 0

**BKB 更新**（アリが経路を通ったとき）:

- 観測値: 100
- リングバッファ: `[100]`
- BKB 値 = max([100]) = **100**

**BKB 揮発**（世代の最後）:

- BKB 値 = 100 × 0.999 = **99.9**

**状態**:

- リングバッファ: `[100]`（**観測値そのまま、揮発されない**）
- BKB 値: 99.9（**揮発後の値**）

---

#### 世代 1

**BKB 更新**（新しい観測値が来たとき）:

- 観測値: 110（例）
- リングバッファ: `[100, 110]`
- BKB 値 = max([100, 110]) = **110** ← **揮発前の観測値で更新！**

**BKB 揮発**（世代の最後）:

- BKB 値 = 110 × 0.999 = **109.89**

**状態**:

- リングバッファ: `[100, 110]`（観測値そのまま）
- BKB 値: 109.89

**重要な点**:

- 揮発後の BKB 値（99.9）ではなく、**バッファ内の max 値（110）で BKB が更新される**
- つまり、**揮発の効果がリセットされる**

---

#### 世代 2

**BKB 更新**:

- 観測値: 105（例）
- リングバッファ: `[100, 110, 105]`
- BKB 値 = max([100, 110, 105]) = **110**

**BKB 揮発**:

- BKB 値 = 110 × 0.999 = **109.89**

---

#### 世代 3-9（同様の処理が続く）

...

---

#### 世代 10（リングバッファが満杯）

**BKB 更新**:

- 観測値: 120（例）
- リングバッファ: `[100, 110, 105, ..., 120]`（10 個）
- BKB 値 = max([100, 110, 105, ..., 120]) = **120**（例）

**BKB 揮発**:

- BKB 値 = 120 × 0.999 = **119.88**

---

#### 世代 11（リングバッファから古い値が削除される）

**BKB 更新**:

- 観測値: 95（例）
- リングバッファ: `[110, 105, ..., 120, 95]`（**最初の 100 が削除される**）
- BKB 値 = max([110, 105, ..., 120, 95]) = **120**（最初の 100 が削除されても、120 が残っている）

**BKB 揮発**:

- BKB 値 = 120 × 0.999 = **119.88**

---

## 重要な理解ポイント

### 1. リングバッファと BKB 値の関係

- **リングバッファ（time_window_values）**: 観測値そのものが保存される（**揮発されない**）
- **BKB 値（best_known_bottleneck）**: バッファ内の**max 値**で更新される
- **揮発処理**: **BKB 値**に対して毎世代行われる（0.999 をかける）

### 2. 揮発の効果が「リセット」される理由

```
世代N:
  揮発後: BKB = 100 × 0.999 = 99.9

世代N+1（新しい観測値が来る）:
  BKB更新: BKB = max([100, 110]) = 110  ← 99.9ではなく110に更新！
  揮発後: BKB = 110 × 0.999 = 109.89
```

**なぜこうなるか？**

BKB 値は、**バッファ内の max 値（観測値そのもの）**で更新されるためです。
揮発後の値（99.9）ではなく、**観測値から計算した max 値（110）**で上書きされます。

### 3. 最初の観測値 100 について

**誤解**: 「最初の観測値 100 に、10 世代で 0.999 が 10 回かけられる」

**実際**:

- リングバッファ内の 100 という観測値は、**揮発されない**（観測値そのまま保存）
- BKB 値は、バッファ内の max 値で更新される
- もし 10 世代後に 100 がバッファ内の最大値のままなら、BKB 値は 100 のまま（揮発されていない）
- しかし、**新しい観測値が来るたびに、BKB 値は max 値で更新される**ため、揮発の効果がリセットされる

### 4. 揮発が効果を発揮するケース

**ケース 1: 新しい観測値が max 値より小さい場合**

```
世代N: バッファ=[100, 110, 105], BKB=110
揮発後: BKB=110×0.999=109.89

世代N+1: 観測値=90（小さい値）
バッファ=[100, 110, 105, 90], BKB=max([100, 110, 105, 90])=110
→ BKBは110のまま（揮発の効果なし）

世代N+2: 観測値=95（小さい値）
バッファ=[100, 110, 105, 90, 95], BKB=110
揮発後: BKB=110×0.999=109.89

世代N+3: 観測値=85（小さい値）
...
→ 最大値110がバッファ内に残っている限り、BKB値は110（または揮発後の109.89）
```

**ケース 2: 最大値がバッファから削除された場合**

```
世代10: バッファ=[100, 110, 105, ..., 120]（10個）, BKB=120
揮発後: BKB=120×0.999=119.88

世代11: 観測値=95
バッファ=[110, 105, ..., 120, 95]（最初の100が削除）, BKB=max([110, ..., 120, 95])=120
→ 最大値120がまだ残っている

世代12-20: ...
世代21: 観測値=85
バッファ=[..., 120が削除される, 85]（120が削除された）
BKB=max([残りの値, 85])  ← 120が削除されたので、新しいmax値になる
```

---

## まとめ

### BKB 値の更新タイミング

1. **アリが経路を通ったとき**（毎回）

   - 観測値をバッファに追加
   - **バッファ内の max 値で BKB 値を更新**（揮発後の値ではなく、観測値から計算）

2. **世代の最後**（毎世代 1 回）
   - BKB 値に 0.999 をかける

### 揮発の実際の効果

- **リングバッファ内の観測値**: 揮発されない（そのまま保存）
- **BKB 値**: 毎世代揮発されるが、新しい観測値が来ると**max 値で上書きされる**

**つまり**:

- 新しい観測値が来るたびに、BKB 値は max 値で更新される
- 揮発の効果は、「新しい観測値が来ない場合」や「max 値がバッファから削除された後」に現れる
- 最初の観測値 100 に 0.999 が 10 回かけられる**わけではない**

### 実際の例

```
世代0: 観測値100 → バッファ=[100], BKB=100 → 揮発後99.9
世代1: 観測値110 → バッファ=[100,110], BKB=110（max値で更新）→ 揮発後109.89
世代2: 観測値105 → バッファ=[100,110,105], BKB=110 → 揮発後109.89
...
世代10: バッファが満杯、BKB=120（例）→ 揮発後119.88
世代11: 新しい観測値が来る → バッファから古い値が削除 → BKB=120（まだ最大値）
```

**結論**: BKB 値は、バッファ内の max 値で更新されるため、揮発の効果は「新しい観測値がない場合」にのみ累積されます。



