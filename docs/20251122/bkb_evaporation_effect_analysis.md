# BKB 揮発（0.999）が精度に影響する理由の分析

## ユーザーの疑問

**「BKB 値が毎回 max 値で上書きされるなら、0.999 をかける処理は意味がないはずなのに、なぜ精度が変わったのか？」**

---

## BKB 値の使用箇所

### 1. フェロモン揮発時のペナルティ判定

**場所**: `src/pheromone_update.py` - `apply_volatilization`関数（143 行目）

```python
# 行き先ノードvが知っている最良のボトルネック帯域(BKB)を取得
bkb_v = graph.nodes[v].get("best_known_bottleneck", 0)

# このエッジの帯域幅が、行き先ノードのBKBより低い場合、ペナルティを課す
if weight_uv < bkb_v:
    rate *= penalty_factor  # 残存率を下げることで、揮発を促進する
```

**効果**:

- エッジの帯域幅 < ノードの BKB → 揮発を促進（ペナルティ）
- エッジの帯域幅 >= ノードの BKB → 通常の揮発率

### 2. フェロモン付加時の功績ボーナス判定

**場所**: `src/pheromone_update.py` - `update_pheromone`関数（271 行目）

```python
# 功績ボーナスの判定（シンプル版）
current_bkb_v = graph.nodes[v].get("best_known_bottleneck", 0)
if bottleneck_bn > current_bkb_v:
    pheromone_increase *= achievement_bonus
```

**効果**:

- 観測ボトルネック > ノードの BKB → ボーナス付与
- 観測ボトルネック <= ノードの BKB → 通常のフェロモン付加

---

## 実行順序の確認

### 典型的な 1 世代の処理順序

```
世代Nの開始
│
├─ [1] 帯域変動（AR(1)）
│
├─ [2] アリの探索（経路選択）
│   └─ フェロモン値に基づいて経路を選択
│       └─ この時点でBKB値が参照される（フェロモン揮発時）
│
├─ [3] フェロモン付加（update_pheromone）
│   └─ アリが通った経路にフェロモンを付加
│       └─ 功績ボーナス判定でBKB値を参照
│
├─ [4] BKB更新（update_node_bkb_time_window_max）
│   └─ リングバッファに観測値を追加
│   └─ バッファ内のmax値をBKBとして設定
│
├─ [5] フェロモン揮発（volatilize_by_width）
│   └─ 全エッジのフェロモンを揮発
│       └─ ペナルティ判定でBKB値を参照
│
└─ [6] BKB揮発（evaporate_bkb_values）
    └─ 全ノードのBKB値に0.999をかける
```

---

## 揮発が効果を発揮するケース

### ケース 1: アリがそのノードを通らない場合

```
世代N-1: ノードXのBKB = 100
        → 揮発後: BKB = 100 × 0.999 = 99.9

世代N: ノードXを経由するアリなし
      → BKB更新なし（99.9のまま）
      → フェロモン揮発時にBKB = 99.9が参照される
      → 帯域幅 < 99.9のエッジにはペナルティが適用される

世代N+1: ノードXを経由するアリなし
        → BKB更新なし
        → 揮発後: BKB = 99.9 × 0.999 = 99.8
```

**効果**:

- BKB 値が徐々に減少
- ペナルティの閾値が下がる
- 低帯域エッジへのペナルティが緩和される

---

### ケース 2: 帯域変動後に新しい高い値が来るまでの間

```
世代N: ノードXのBKB = 100（高い値）
      → 揮発後: BKB = 99.9
      → 帯域変動: エッジの帯域幅が下がる（例: 80）

世代N+1: アリがまだ高い帯域経路を通る
        → BKB更新なし（99.9のまま）
        → フェロモン揮発時: エッジ帯域幅80 < BKB 99.9
        → ペナルティ適用（揮発促進）

世代N+2: アリが低帯域経路（80）を通る
        → 観測値80 → BKB更新: max(99.9, 80) = 99.9（変わらず）
        → 揮発後: BKB = 99.9 × 0.999 = 99.8

世代N+3: アリが低帯域経路（80）を通る
        → 観測値80 → BKB更新: max(99.8, 80) = 99.8（変わらず）
        → 揮発後: BKB = 99.8 × 0.999 = 99.7

...

世代N+K: 揮発が累積して、BKB < 80になるまで続く
        → 最終的に: BKB ≈ 80
        → ペナルティが解除される
```

**効果**:

- 帯域変動後、古い高い BKB 値が「陳腐化」するまで時間がかかる
- 揮発がないと、永遠に高い BKB 値が残り続ける
- 揮発があると、徐々に新しい状況に適応する

---

### ケース 3: 同じ世代内で複数のアリが同じノードを通る場合

```
世代N:
  - アリ1: ノードXを通る → 観測値100 → BKB更新: 100
  - アリ2: ノードXを通る → 観測値90
    → BKB更新: max(100, 90) = 100（変わらず）
  - アリ3: ノードXを通る → 観測値110 → BKB更新: 110

  → フェロモン揮発: BKB = 110が参照される
  → 最終的に: BKB揮発 → 110 × 0.999 = 109.89

世代N+1:
  - アリがノードXを通らない
  - フェロモン揮発: BKB = 109.89が参照される
  - BKB揮発: 109.89 × 0.999 = 109.78
```

**効果**:

- 同じ世代内では効果が小さい（max 値で上書きされるため）
- しかし、次の世代でアリが通らない場合に効果が現れる

---

## 揮発が「意味を持つ」理由

### 1. **BKB 更新と揮発のタイミングの違い**

```
フェロモン揮発（BKB値を使用） → BKB揮発 → 次の世代
```

- フェロモン揮発時に「揮発前の BKB 値」が使われる
- その後、BKB 揮発が適用される
- 次の世代のフェロモン揮発時には「揮発後の BKB 値」が使われる

### 2. **アリがそのノードを通らない期間**

- アリがノードを通らない間、BKB 値は揮発し続ける
- これにより、古い高い BKB 値が「陳腐化」する
- 帯域変動への適応が促進される

### 3. **ペナルティの閾値の調整**

```
BKB値が高い → ペナルティの閾値が高い → 多くのエッジがペナルティを受ける
BKB値が低い → ペナルティの閾値が低い → ペナルティを受けるエッジが減る
```

- 揮発により BKB 値が下がる → ペナルティの閾値が下がる
- 帯域変動後、新しい状況に適応しやすくなる

---

## 精度が変わる理由（まとめ）

### 揮発がない場合（BKB_EVAPORATION_RATE = 1.0）

```
世代0: ノードXのBKB = 100（高い帯域を観測）
世代100: 帯域変動 → エッジ帯域幅 = 80
        → アリがノードXを通らない間、BKB = 100のまま
        → フェロモン揮発時: エッジ帯域幅80 < BKB 100
        → ペナルティ適用（揮発促進）
        → しかし、アリは80の経路を避け続ける（BKBが高すぎる）
        → 適応が遅い
```

### 揮発がある場合（BKB_EVAPORATION_RATE = 0.999）

```
世代0: ノードXのBKB = 100
世代100: 帯域変動 → エッジ帯域幅 = 80
        → アリがノードXを通らない間、BKBが揮発
        → 世代110: BKB ≈ 100 × 0.999^10 ≈ 99.0
        → 世代200: BKB ≈ 100 × 0.999^100 ≈ 90.5
        → 世代300: BKB ≈ 100 × 0.999^200 ≈ 82.0
        → フェロモン揮発時: エッジ帯域幅80 < BKB 82.0
        → ペナルティが緩和される
        → アリが80の経路を選びやすくなる
        → 適応が早い
```

---

## 結論

**0.999 をかけるだけで精度が変わる理由**:

1. **BKB 値は「毎回 max 値で上書きされる」わけではない**

   - アリがそのノードを通らない期間は、BKB 値は揮発し続ける
   - 帯域変動後、新しい状況に適応するまでに時間がかかるが、揮発があると適応が促進される

2. **フェロモン揮発時のペナルティ判定に影響する**

   - 揮発後の BKB 値がペナルティの閾値になる
   - BKB 値が高いと、多くのエッジがペナルティを受ける
   - BKB 値が低いと、ペナルティを受けるエッジが減る

3. **帯域変動への適応を促進する**
   - 古い高い BKB 値が「陳腐化」する
   - 新しい低い帯域状況に適応しやすくなる

**ただし、現在の実装では以下の問題があります**:

- リングバッファ内の観測値が揮発されない
- BKB 値は揮発されるが、新しい観測値が来ると max 値で上書きされる
- ユーザーの期待（「1000 世代前の観測値は 36.8 になる」）は満たされていない

---

## 今後の改善案

1. **リングバッファ内の値に揮発を適用**（前のドキュメントの案 1）

   - バッファ内の各値に毎世代揮発を適用
   - 古い観測値が「価値が減る」

2. **世代情報を記録して経過世代数を考慮**
   - より正確な時間減衰を実現



