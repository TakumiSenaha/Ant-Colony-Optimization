# ACS実装の重大なバグ修正サマリー

## 修正日時
2026-01-11

## 発見した問題

### 🚨 **致命的なバグ: フェロモンが減少していた**

**症状:**
- ACSの結果がすこぶる悪い
- 特に変動なし環境でも期待通りの結果が出ない
- 学習が機能していない様子

**原因:**
グローバル更新で、Global Bestの経路のフェロモンが**減少**していた。

---

## バグの詳細

### 問題のあったコード

```python
# 修正前（誤り）
bottleneck = 80  # Global Bestのボトルネック帯域
delta_tau = bottleneck / 100.0  # 0.8に正規化（← これが問題）
rho = 0.1
current_tau = 1.0  # 初期フェロモン（← これも小さすぎた）

# グローバル更新
new_tau = (1.0 - rho) * current_tau + rho * delta_tau
        = 0.9 * 1.0 + 0.1 * 0.8
        = 0.9 + 0.08
        = 0.98  # ← 初期値1.0より減少！

delta_pheromone = 0.98 - 1.0 = -0.02  # 負の値！
```

**結果:**
- Global Bestの経路のフェロモンが減少
- 良い経路が強化されない
- 学習が全く機能しない

---

## バグの原因分析

### スケールのアンバランス

| パラメータ | 修正前 | 問題点 |
|-----------|--------|--------|
| **τ₀** | 1.0 | 小さすぎる |
| **Δτ** | 0.8（正規化後） | τ₀より小さい → 減少 |
| **バランス** | τ₀ > Δτ | アンバランス（増加しない） |

**TSP論文との比較:**
```
TSP論文:
  τ₀ = 1/(n*L_nn) ≈ 0.001
  Δτ = 1/L_gb ≈ 0.001～0.01
  → τ₀とΔτが同じオーダー ✅

修正前のMBL:
  τ₀ = 1.0
  Δτ = 0.8（正規化後）
  → τ₀ > Δτ（アンバランス）❌
```

---

## 修正内容

### ✅ **修正: 生の帯域スケールを使用**

```python
# 修正後（正しい）
bottleneck = 80  # Global Bestのボトルネック帯域
delta_tau = bottleneck  # 80（正規化しない ← 修正）
rho = 0.1
current_tau = 10.0  # 初期フェロモン（← 修正）

# グローバル更新
new_tau = (1.0 - rho) * current_tau + rho * delta_tau
        = 0.9 * 10.0 + 0.1 * 80.0
        = 9.0 + 8.0
        = 17.0  # ← 初期値10.0から増加！✅

delta_pheromone = 17.0 - 10.0 = 7.0  # 正の値！
```

**結果:**
- Global Bestの経路のフェロモンが正しく増加
- 良い経路が強化される
- 学習が機能する

---

## 修正したパラメータ

| パラメータ | 修正前 | 修正後 | 理由 |
|-----------|--------|--------|------|
| **τ₀** | 1.0 | **10.0** | 生の帯域スケール（10～100）の最小値に対応 |
| **Δτ** | B_gb/100 | **B_gb** | 正規化しない、生の帯域幅を使用 |
| **min_pheromone** | 0.01 | **1.0** | τ₀の1/10程度 |
| **max_pheromone** | 10.0 | **1000.0** | 十分大きい上限 |
| **η（ヒューリスティック）** | w_ij/100 | **w_ij/100（変更なし）** | 計算安定性のため正規化を維持 |

---

## スケールバランスの確認

### 修正後のバランス

```
MBL問題（修正後）:
  τ₀ = 10.0
  Δτ = 10～100（生の帯域幅）
  → τ₀とΔτが同じオーダー ✅

TSP論文:
  τ₀ = 0.001
  Δτ = 0.001～0.01
  → τ₀とΔτが同じオーダー ✅
```

**結論: 修正後、TSP論文と同じバランス関係になりました。**

---

## 計算例（修正後）

### 初期世代

```python
# 初期状態
current_tau = 10.0
delta_tau = 80.0  # Global Bestのボトルネック帯域
rho = 0.1

# グローバル更新
new_tau = 0.9 * 10.0 + 0.1 * 80.0
        = 9.0 + 8.0
        = 17.0  # ← 増加！
```

### 2世代目（同じGlobal Bestが維持された場合）

```python
# 前回の更新後
current_tau = 17.0
delta_tau = 80.0
rho = 0.1

# グローバル更新
new_tau = 0.9 * 17.0 + 0.1 * 80.0
        = 15.3 + 8.0
        = 23.3  # ← さらに増加！
```

### 10世代後（収束）

```python
# 収束値の計算
# τ = (1-ρ)τ + ρΔτ
# 収束時: τ = (1-ρ)τ + ρΔτ
# τ - (1-ρ)τ = ρΔτ
# ρτ = ρΔτ
# τ = Δτ = 80.0
```

**結論: Global Bestの経路のフェロモンは、最終的にΔτ（ボトルネック帯域）に収束します。**

---

## 論文準拠性の確認

### 修正前後の比較

| 項目 | 論文の意図 | 修正前 | 修正後 |
|------|-----------|--------|--------|
| **τ₀とΔτのバランス** | 同じオーダー | アンバランス ❌ | **同じオーダー** ✅ |
| **GB経路のフェロモン** | 増加 | 減少していた ❌ | **増加する** ✅ |
| **学習の機能** | 良い経路を強化 | 機能していなかった ❌ | **機能する** ✅ |
| **状態遷移規則** | q₀=0.9で分岐 | 正しい ✅ | **正しい** ✅ |
| **ローカル更新** | 訪問直後に適用 | 正しい ✅ | **正しい** ✅ |
| **グローバル更新対象** | GB経路のみ | 正しい ✅ | **正しい** ✅ |

---

## まとめ

### 何が問題だったか

**「ACSが実装できていなかった」というより、「Δτのスケーリングが誤っていた」**

- アルゴリズム構造: ✅ 正しく実装されていた
- パラメータバランス: ❌ τ₀とΔτのスケールが合っていなかった
- 結果: Global Bestの経路が強化されず、学習が機能していなかった

### 修正後の状態

- ✅ Δτ = B_gb（生の帯域幅、正規化しない）
- ✅ τ₀ = 10.0（生の帯域スケールに合わせる）
- ✅ τ₀とΔτが同じオーダー（TSP論文と同じバランス）
- ✅ Global Bestの経路のフェロモンが正しく増加
- ✅ 学習が機能する

### 目新しい部分（TTL/Window）

- ✅ そのまま維持
- ✅ コアアルゴリズムの修正のみ
- ✅ 論文準拠の実装が完成


